import os
import time
import glob


def collectData():
	time.sleep(1)
	os.system("daq_evtbuild -m 1 -d file -o /home/pandastraws/asicMeasurements/tot_scan/out_data  -q 128 &")
	os.system("daq_netmem -m 1 -i UDP:127.0.0.1:50000 -q 128 &")
	time.sleep(20)
	os.system("killall -9 daq_evtbuild")
	os.system("killall -9 daq_netmem")
	time.sleep(1)

def setAsic(marker):
	if(marker == 0):#FEBs set for the first time. Reset and set all parameters
		print 'Resetting the FEBs, please wait...'
#		os.system('trbcmd w 0xe000 0xa000 0x300000')
#		time.sleep(1)
#		os.system('trbcmd w 0xe000 0xa000 0x280000')
#		time.sleep(1)
#		os.system('trbcmd w 0xe000 0xa000 0x200000')
#		time.sleep(1)
		os.system('trbcmd w 0xe001 0xa000 0x300000')
		time.sleep(1)
		os.system('trbcmd w 0xe001 0xa000 0x280000')
		time.sleep(1)
		os.system('trbcmd w 0xe001 0xa000 0x200000')
		time.sleep(1)
                
#		os.system('trbcmd w 0xe000 0xa000 0x52015')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x5212c')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x5223a')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x52300')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x5241f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x5251f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x5261f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x5271f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x5281f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x5291f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x52a1f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x52b1f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x54015')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x5412c')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x5423a')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x54300')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x5441f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x5451f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x5461f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x5471f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x5481f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x5491f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x54a1f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x54b1f')
#		time.sleep(1)
##FEB2                
#		os.system('trbcmd w 0xe000 0xa000 0xd2015')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0xd212c')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0xd223a')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0xd2300')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0xd241f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0xd251f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0xd261f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0xd271f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0xd281f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0xd291f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0xd2a1f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0xd2b1f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0xd4015')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0xd412c')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0xd423a')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0xd4300')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0xd441f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0xd451f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0xd461f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0xd471f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0xd481f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0xd491f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0xd4a1f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0xd4b1f')
#		time.sleep(1)
##FEB3
#                os.system('trbcmd w 0xe000 0xa000 0x152015')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x15212c')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x15223a')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x152300')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x15241f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x15251f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x15261f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x15271f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x15281f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x15291f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x152a1f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x152b1f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x154015')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x15412c')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x15423a')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x154300')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x15441f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x15451f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x15461f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x15471f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x15481f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x15491f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x154a1f')
#		time.sleep(1)
#                os.system('trbcmd w 0xe000 0xa000 0x154b1f')
#		time.sleep(1)
   #TDC 2 CONN 3
#                os.system('trbcmd w 0xe001 0xa000 0x152015')
#                time.sleep(1)
#                os.system('trbcmd w 0xe001 0xa000 0x15212c')
#                time.sleep(1)
#                os.system('trbcmd w 0xe001 0xa000 0x15223a')
#                time.sleep(1)
#                os.system('trbcmd w 0xe001 0xa000 0x152300')
#                time.sleep(1)
#                os.system('trbcmd w 0xe001 0xa000 0x15241f')
#                time.sleep(1)
#                os.system('trbcmd w 0xe001 0xa000 0x15251f')
#                time.sleep(1)
#                os.system('trbcmd w 0xe001 0xa000 0x15261f')
#                time.sleep(1)
#                os.system('trbcmd w 0xe001 0xa000 0x15271f')
#                time.sleep(1)
#                os.system('trbcmd w 0xe001 0xa000 0x15281f')
#                time.sleep(1)
#                os.system('trbcmd w 0xe001 0xa000 0x15291f')
#                time.sleep(1)
#                os.system('trbcmd w 0xe001 0xa000 0x152a1f')
#                time.sleep(1)
#                os.system('trbcmd w 0xe001 0xa000 0x152b1f')
#                time.sleep(1)
                os.system('trbcmd w 0xe001 0xa000 0x154017')
                time.sleep(1)
                os.system('trbcmd w 0xe001 0xa000 0x15412c')
                time.sleep(1)
                os.system('trbcmd w 0xe001 0xa000 0x15423a')
                time.sleep(1)
                os.system('trbcmd w 0xe001 0xa000 0x154300')
                time.sleep(1)
                os.system('trbcmd w 0xe001 0xa000 0x15441f')
                time.sleep(1)
                os.system('trbcmd w 0xe001 0xa000 0x15451f')
                time.sleep(1)
                os.system('trbcmd w 0xe001 0xa000 0x15461f')
                time.sleep(1)
                os.system('trbcmd w 0xe001 0xa000 0x15471f')
                time.sleep(1)
                os.system('trbcmd w 0xe001 0xa000 0x15481f')
                time.sleep(1)
                os.system('trbcmd w 0xe001 0xa000 0x15491f')
                time.sleep(1)
                os.system('trbcmd w 0xe001 0xa000 0x154a1f')
                time.sleep(1)
                os.system('trbcmd w 0xe001 0xa000 0x154b1f')
                time.sleep(1)


		print 'resetting done!\n'
	else:#change only threshold
		strHex = "%0.2x" % marker
		print 'Setting thresholds to : '+ strHex
#		os.system('trbcmd w 0xe000 0xa000 0x523'+strHex)
#                time.sleep(1)
		
#                os.system('trbcmd w 0xe000 0xa000 0x543'+strHex)
#		time.sleep(1)

#                os.system('trbcmd w 0xe000 0xa000 0xd23'+strHex)
#		time.sleep(1)
	
#                os.system('trbcmd w 0xe000 0xa000 0xd43'+strHex)
#		time.sleep(1)

#                os.system('trbcmd w 0xe000 0xa000 0x1523'+strHex)
#		time.sleep(1)

#                os.system('trbcmd w 0xe000 0xa000 0x1543'+strHex)
#		time.sleep(1)
		#TDC 2 CONN 3
                os.system('trbcmd w 0xe001 0xa000 0x1523'+strHex)
                time.sleep(1)

                os.system('trbcmd w 0xe001 0xa000 0x1543'+strHex)
                time.sleep(1)


for i in range (0,120):
	setAsic(i)
	collectData()
	threshold = "%0.3i" % i
	newest = max(glob.iglob('/home/pandastraws/asicMeasurements/tot_scan/out_data/*.hld'), key=os.path.getctime)
	os.system ('mv '+newest+' '+newest[0:-4]+'_'+threshold+'.hld')
	#print 'mv '+newest+' '+newest[0:-4]+'_'+threshold+'.hld'
	print '\n\n=======> '+str(i)+'\n\n'





